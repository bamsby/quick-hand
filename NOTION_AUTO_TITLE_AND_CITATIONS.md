# Notion Auto-Title Generation & Citations Feature

## Summary

This document describes the implementation of automatic title generation and citation inclusion for Notion pages.

## Features Implemented

### 1. **Auto-Generated Titles Using OpenAI**
- Titles are now automatically generated by OpenAI LLM based on the content
- Users can still edit the auto-generated title in the confirmation modal
- Title generation happens on the server side in the `plan` edge function
- Maximum 60 characters, concise and descriptive

### 2. **Citations Included in Notion Pages**
- All citations from web searches are now automatically included at the end of Notion pages
- Citations appear in a "Sources" section with:
  - Citation number (e.g., [1], [2])
  - Title (formatted in bold)
  - URL link
- Bold formatting is properly rendered in Notion using rich text annotations

### 3. **Smart Citation Limiting**
- **Simple queries** (e.g., "what is X", "define Y") → **1 citation**
- **Most queries** (general questions) → **3 citations** (default)
- **Complex queries** (e.g., "compare X vs Y", "comprehensive guide") → **5 citations**

## Technical Changes

### Modified Files

#### 1. `supabase/functions/plan/index.ts`
- Added `getCitationLimit()` function to determine query complexity
- Added `generateTitle()` function to auto-generate titles using OpenAI
- Modified `searchExa()` to accept a `limit` parameter
- Updated Notion action creation to:
  - Auto-generate title
  - Include citations in action params

#### 2. `supabase/functions/notion-create-page/index.ts`
- Added `citations` field to `RequestBody` interface
- Added `parseRichText()` function to handle markdown bold formatting (`**text**`)
- Updated `contentToNotionBlocks()` to support rich text with bold annotations
- Modified page creation to append citations as a "Sources" section

#### 3. `lib/api.ts`
- Updated `notionCreatePage()` function signature to accept optional `citations` parameter

#### 4. `app/chat.tsx`
- Updated `confirmNotionAction()` to pass citations to `notionCreatePage()`
- Updated `executeAllActions()` to pass citations to `notionCreatePage()`

## How It Works

### Flow

1. **User asks a question** that triggers web search (e.g., "latest AI hackathons")
2. **Plan function**:
   - Determines citation limit based on query complexity (1, 3, or 5)
   - Searches Exa API with the appropriate limit
   - Gets response from OpenAI with inline citations [1], [2], etc.
   - If "save" or "notion" is mentioned, generates a title using OpenAI
   - Creates Notion action with auto-generated title, content, and citations
3. **User confirms** in the Notion modal (can edit the auto-generated title)
4. **Notion page is created** with:
   - Auto-generated (or edited) title
   - Main content with inline citation numbers
   - "Sources" section at the end with full citation details

### Example

**User Query:** "What are the latest AI hackathons and save to Notion"

**LLM Response:** "Here are some of the latest AI hackathons: [1] mentions the upcoming AI Challenge 2025..."

**Auto-Generated Title:** "Latest AI Hackathons"

**Notion Page Content:**
```
Here are some of the latest AI hackathons: [1] mentions the upcoming AI Challenge 2025...

## Sources

**[1] AI Hackathon Calendar 2025**
https://example.com/ai-hackathons

**[2] Top Tech Competitions This Year**
https://example.com/tech-competitions

**[3] Developer Events Guide**
https://example.com/dev-events
```

## Benefits

1. **Saves time**: Users don't need to manually create titles
2. **Better organization**: Consistent, descriptive titles
3. **Source attribution**: All citations are preserved in Notion for future reference
4. **Smarter results**: Query complexity determines the right number of sources (not too few, not too many)
5. **Editable**: Users can still modify the auto-generated title before saving

## Testing

To test the feature:

1. Ask a simple question: "What is OpenAI?" → Expect 1 citation
2. Ask a general question: "Tell me about AI hackathons" → Expect 3 citations
3. Ask a complex question: "Compare GPT-4 vs Claude differences" → Expect 5 citations
4. Add "save to Notion" to any query → Title is auto-generated
5. Check the Notion page → Citations should appear in the Sources section

## Future Enhancements

- Allow users to customize citation limit preferences
- Support other markdown formatting (italic, links) in Notion
- Add option to exclude specific citations
- Support citation styles (APA, MLA, etc.)

